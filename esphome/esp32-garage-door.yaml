substitutions:
  device_name: esp32-garage-door
  friendly_name: "Garage Door Controller"

  # GPIO Assignments for ESP32-C6 DevKit
  garage_door_relay_pin: GPIO12
  garage_door_closed_switch_pin: GPIO4
  garage_door_encoder_a_pin: GPIO5
  garage_door_encoder_b_pin: GPIO6

  # NOTE: Calibrate this value by opening the door fully and noting the encoder count
  garage_door_full_open_counts: "10000"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32-c6-devkitc-1
  variant: esp32c6
  framework:
    type: esp-idf

# Standard ESPHome integrations
captive_portal:
api:
ota:
logger:
web_server:

switch:
  # Relay connected to the ESP32-C6
  - platform: gpio
    name: "Garage Door Relay"
    pin: ${garage_door_relay_pin}
    id: garage_door_relay
    on_turn_on:
      - delay: 200ms
      - switch.turn_off: garage_door_relay

binary_sensor:
  # Closed-limit switch connected to the ESP32-C6
  - platform: gpio
    name: "Garage Door Closed Switch"
    id: garage_door_closed_switch
    pin:
      number: ${garage_door_closed_switch_pin}
      mode: INPUT_PULLUP
      inverted: true
    device_class: door
    on_press:
      # When door is fully closed, reset encoder count to 0 for calibration
      - sensor.rotary_encoder.set_value:
          id: garage_door_encoder
          value: 0

sensor:
  # Rotary encoder connected to the ESP32-C6
  - platform: rotary_encoder
    name: "Garage Door Position Encoder"
    id: garage_door_encoder
    pin_a: ${garage_door_encoder_a_pin}
    pin_b: ${garage_door_encoder_b_pin}

cover:
  - platform: template
    name: "Garage Door"
    id: garage_door
    device_class: garage
    open_action:
      - switch.turn_on: garage_door_relay
    close_action:
      - switch.turn_on: garage_door_relay
    stop_action:
      - switch.turn_on: garage_door_relay
    position:
      lambda: |-
        if (id(garage_door_closed_switch).state) {
          return 0.0;
        }
        float val = clamp((float)id(garage_door_encoder).state, 0.0f, (float)${garage_door_full_open_counts});
        return val / (float)${garage_door_full_open_counts};
    optimistic: false
    assumed_state: false