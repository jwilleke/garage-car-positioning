substitutions:
  device_name: garage-car-sensor
  friendly_name: "Garage Car Sensor"
  
  # Target parking zone (adjust after calibration)
  target_y_min: "1800"
  target_y_max: "2200"
  target_x_tolerance: "300"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: dio

esp32:
  board: esp32-c6-devkitc-1
  variant: esp32c6
  framework:
    type: esp-idf
    version: recommended

logger:
  level: DEBUG

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "${device_name}-AP"
    password: !secret ap_password

captive_portal:

uart:
  - id: uart_ld2450_front
    rx_pin: GPIO16
    tx_pin: GPIO17
    baud_rate: 256000
    
  - id: uart_ld2450_rear
    rx_pin: GPIO18
    tx_pin: GPIO19
    baud_rate: 256000

ld2450:
  - id: ld2450_front
    uart_id: uart_ld2450_front
    throttle: 500ms
    
  - id: ld2450_rear
    uart_id: uart_ld2450_rear
    throttle: 500ms

sensor:
  - platform: ld2450
    ld2450_id: ld2450_front
    target_count:
      name: "Front Sensor Target Count"
    target_1:
      x:
        name: "Front Target X"
        id: front_x
      y:
        name: "Front Target Y"
        id: front_y
      distance:
        name: "Front Target Distance"
        id: front_distance

  - platform: ld2450
    ld2450_id: ld2450_rear
    target_count:
      name: "Rear Sensor Target Count"
    target_1:
      x:
        name: "Rear Target X"
        id: rear_x
      y:
        name: "Rear Target Y"
        id: rear_y
      distance:
        name: "Rear Target Distance"
        id: rear_distance

  - platform: template
    name: "Car Center X Position"
    id: car_center_x
    unit_of_measurement: "mm"
    lambda: |-
      if (id(front_x).state != 0 && id(rear_x).state != 0) {
        return (id(front_x).state + id(rear_x).state) / 2.0;
      }
      return 0;
    update_interval: 500ms

  - platform: template
    name: "Car Center Y Position"
    id: car_center_y
    unit_of_measurement: "mm"
    lambda: |-
      if (id(front_y).state != 0 && id(rear_y).state != 0) {
        return (id(front_y).state + id(rear_y).state) / 2.0;
      }
      return 0;
    update_interval: 500ms

binary_sensor:
  - platform: template
    name: "Car Detected"
    id: car_detected
    device_class: occupancy
    lambda: |-
      return (id(front_distance).state > 100) || (id(rear_distance).state > 100);
    filters:
      - delayed_on: 1s
      - delayed_off: 5s

  - platform: template
    name: "Car Correctly Parked"
    id: car_correctly_parked
    device_class: occupancy
    lambda: |-
      float y = id(car_center_y).state;
      float x = abs(id(car_center_x).state);
      bool y_ok = (y >= ${target_y_min}) && (y <= ${target_y_max});
      bool x_ok = x <= ${target_x_tolerance};
      return id(car_detected).state && y_ok && x_ok;

text_sensor:
  - platform: template
    name: "Parking Guidance"
    lambda: |-
      if (!id(car_detected).state) {
        return {"No car detected"};
      }
      if (id(car_correctly_parked).state) {
        return {"âœ… Perfect!"};
      }
      float y = id(car_center_y).state;
      float target = (${target_y_min} + ${target_y_max}) / 2.0;
      if (y < target - 100) return {"â¬†ï¸ Move FORWARD"};
      if (y > target + 100) return {"â¬‡ï¸ Move BACK"};
      return {"ğŸ”„ Minor adjustment"};
    update_interval: 500ms

button:
  - platform: restart
    name: "Restart"
