substitutions:
  device_name: simple-wifi-test
  friendly_name: "Simple WiFi Test"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  # Version marker - update this when making changes
  comment: "GPIO4 Switch Test - v1.0 - 2026-01-15"

esp32:
  board: esp32-c6-devkitc-1
  variant: esp32c6
  framework:
    type: esp-idf
    version: recommended

logger:
  level: DEBUG
  hardware_uart: USB_SERIAL_JTAG

# Try WiFi connection - fallback to AP if it fails
wifi:
  enable_on_boot: true
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # fast_connect: true  # Disabled - can cause issues with WPA2/WPA3 mixed mode
  power_save_mode: none
  reboot_timeout: 10min
  domain: .local
  
  ap:
    ssid: "simple-wifi-test"
    password: "test1234"
    ap_timeout: 1min  # Start AP after 1 minute if WiFi fails

captive_portal:
  # Connect to "simple-wifi-test" WiFi and open any browser
  # You'll be redirected to configure WiFi credentials for SWIT2

api:
  # API might be required for web server to work properly

ota:
  - platform: esphome
    password: !secret ota_password

web_server:
  port: 80
  # version: 2  # Try default version first
  include_internal: false

# Component Test: GPIO4 - Closed Door Reed Switch
# Wiring: Connect one leg to GPIO4, other leg to GND
# Expected: Switch OPEN when door is OPEN, CLOSED when door is CLOSED
binary_sensor:
  - platform: gpio
    name: "Garage Door Closed Switch"
    id: garage_door_closed_switch
    pin:
      number: GPIO4
      mode:
        input: true
        pullup: true
      inverted: true
    device_class: door
    internal: false  # Make sure it's not hidden
    on_press:
      - logger.log:
          format: "*** GPIO4: Door switch PRESSED (Door CLOSED) ***"
          level: INFO
    on_release:
      - logger.log:
          format: "*** GPIO4: Door switch RELEASED (Door OPEN) ***"
          level: INFO
    on_state:
      - logger.log:
          format: "GPIO4 State Change: %s"
          args: ['id(garage_door_closed_switch).state ? "CLOSED" : "OPEN"']
          level: INFO
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms

# Add a simple sensor so web interface has something to display
sensor:
  - platform: wifi_signal
    name: "WiFi Signal"
    update_interval: 60s
  - platform: uptime
    name: "Uptime"
  # GPIO4 State Sensor - Shows current pin state for debugging
  - platform: template
    name: "GPIO4 Pin State"
    internal: false  # Make sure it's visible
    lambda: |-
      bool state = id(garage_door_closed_switch).state;
      return state ? 1.0 : 0.0;
    update_interval: 2s
    unit_of_measurement: ""
    on_value:
      - logger.log:
          format: "GPIO4 Pin State: %s (1=CLOSED, 0=OPEN)"
          args: ['id(garage_door_closed_switch).state ? "CLOSED" : "OPEN"']
          level: INFO

button:
  - platform: restart
    name: "Restart Device"

# Status text sensor
text_sensor:
  - platform: wifi_info
    ip_address:
      name: "IP Address"
    ssid:
      name: "SSID"
    mac_address:
      name: "MAC Address"
  # Version marker - logs version info on first update
  - platform: template
    name: "Code Version"
    id: code_version
    lambda: |-
      return "GPIO4 Switch Test v1.0 - 2026-01-15";
    update_interval: 60s
    on_value:
      - logger.log:
          format: "=========================================="
          level: INFO
      - logger.log:
          format: "Code Version: GPIO4 Switch Test v1.0"
          level: INFO
      - logger.log:
          format: "Build Date: 2026-01-15"
          level: INFO
      - logger.log:
          format: "Testing: GPIO4 Closed Door Switch"
          level: INFO
      - logger.log:
          format: "=========================================="
          level: INFO